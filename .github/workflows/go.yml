name: Go

permissions:
  contents: write
  actions: write
  pull-requests: read

on:
  push:
  pull_request:
  release:
    types: [created]

env:
  release_name: build_${{github.run_number}}
  branch: ${{github.ref_name}}

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: stable
    - name: Install gofumpt
      run: go install mvdan.cc/gofumpt@latest
    - name: Check formating
      run: gofumpt -d ./
      
  lint:
    needs: format
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: stable
    - name: Install staticcheck
      run: |
        sudo apt update
        sudo apt upgrade -y
        apt install go-staticcheck
    - name: Install errcheck
      run: go install github.com/kisielk/errcheck@latest
    - name: golangci-lint
      uses: golangci/golangci-lint-action@v9
      with:
          version: v2.6.1
    - name: Install revive
      run: go install github.com/mgechev/revive@latest        
    - name: Install go-critic
      run: go install -v github.com/go-critic/go-critic/cmd/go-critic@latest 
    - name: Check
      run: make lint
      
  build-linux:
    needs: lint
    strategy:
      matrix:
        os: [ubuntu-latest]
        platform: [64]
    runs-on: ${{matrix.os}}
    steps:
    - uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: stable
    - name: Test
      run: go test -v ./...
    - name: Build
      run: go build -v ./...
    - name: Build Artifact
      run: go build -v .
    - name: Create Zip
      run: zip ./dreamdump-${{env.release_name}}_linux_${{matrix.platform}}.zip ./dreamdump
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: dreamdump-${{env.release_name}}_linux_${{matrix.platform}}
        path: ./dreamdump-${{env.release_name}}_linux_${{matrix.platform}}.zip

  build-windows:
    needs: lint
    strategy:
      matrix:
        os: [windows-2022]
        platform: [64]
    runs-on: ${{matrix.os}}
    steps:
    - uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: stable
    - name: Test
      run: go test -v ./...
    - name: Build
      run: go build -v ./...
    - name: Build Artifact
      run: go build -v .
    - name: Create Zip
      run: Compress-Archive -Path ./dreamdump.exe -DestinationPath dreamdump-${{env.release_name}}_win_${{matrix.platform}}.zip
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: dreamdump-${{env.release_name}}_win_${{matrix.platform}}
        path: ./dreamdump-${{env.release_name}}_win_${{matrix.platform}}.zip
  
  release:
    if: ${{ github.event_name == 'release'}}
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
      - name: 'Upload Release'
        shell: bash
        run: |
          shopt -s nullglob
          files=(dreamdump-*.zip)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No artifacts to release"; exit 1
          fi
          gh release upload ${{ github.event.release.tag_name }} "${files[@]}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
